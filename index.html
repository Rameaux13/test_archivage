<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocScan - Num√©risation et gestion de documents</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background-color: #3498db;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .scanner-section, .document-section, .search-section {
      background-color: white;
      border-radius: 5px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 {
      color: #3498db;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover {
      background-color: #2980b9;
    }
    #video-container {
      position: relative;
      max-width: 100%;
      margin: 0 auto;
    }
    #video {
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    #capture-btn {
      margin-top: 10px;
    }
    #preview {
      max-width: 100%;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-top: 10px;
      display: none;
    }
    .document-list {
      list-style: none;
      padding: 0;
    }
    .document-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .document-item:hover {
      background-color: #f9f9f9;
    }
    .document-actions button {
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 12px;
    }
    #search-box {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .hidden {
      display: none;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .filter-btn {
      margin-right: 5px;
      margin-bottom: 10px;
    }
    .filter-btn.active {
      background-color: #2c3e50;
    }
    .status-info {
      font-style: italic;
      color: #666;
      margin: 10px 0;
    }
    .category-tag {
      display: inline-block;
      padding: 3px 8px;
      font-size: 12px;
      border-radius: 10px;
      margin-left: 10px;
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>DocScan</h1>
      <p>Num√©risation et gestion intelligente de documents</p>
    </header>
    
    <div class="scanner-section">
      <h2>üì∏ Acquisition des documents</h2>
      <div id="video-container">
        <video id="video" autoplay></video>
      </div>
      <button id="start-camera">Activer la cam√©ra</button>
      <button id="capture-btn" disabled>Capturer document</button>
      <img id="preview" alt="Aper√ßu du document">
      <div id="process-controls" class="hidden">
        <button id="process-btn">Traiter le document</button>
        <button id="retake-btn">Reprendre</button>
      </div>
      <div id="processing-loader" class="loader hidden"></div>
      <div id="status-message" class="status-info hidden"></div>
    </div>
    
    <div class="document-section">
      <h2>üóÇ Documents sauvegard√©s</h2>
      <div class="document-filters">
        <button class="filter-btn active" data-category="all">Tous</button>
        <button class="filter-btn" data-category="Documents financiers">Financiers</button>
        <button class="filter-btn" data-category="Documents l√©gaux">L√©gaux</button>
        <button class="filter-btn" data-category="Documents d'identification">Identification</button>
        <button class="filter-btn" data-category="Documents administratifs">Administratifs</button>
        <button class="filter-btn" data-category="Documents commerciaux">Commerciaux</button>
        <button class="filter-btn" data-category="Documents √©ducatifs">√âducatifs</button>
        <button class="filter-btn" data-category="Documents m√©dicaux">M√©dicaux</button>
        <button class="filter-btn" data-category="autre">Autres</button>
      </div>
      <ul class="document-list" id="document-list">
        <li class="no-documents">Aucun document trouv√©.</li>
      </ul>
    </div>
    
    <div class="search-section">
      <h2>üîç Recherche</h2>
      <input type="text" id="search-box" placeholder="Rechercher dans vos documents...">
      <div id="search-results"></div>
    </div>
  </div>

  <script>
    // Variables globales
    let stream;
    let capturedImage;
    let documents = JSON.parse(localStorage.getItem('documents')) || [];
    
    // Cl√©s API
    const OCR_API_KEY = "K89517877488957";
    const GEMINI_API_KEY = "AIzaSyBbC1XQxdnttTyRbTAuTr5c1j71UOPHcNA";
    
    // √âl√©ments DOM
    const startCameraButton = document.getElementById('start-camera');
    const video = document.getElementById('video');
    const captureButton = document.getElementById('capture-btn');
    const preview = document.getElementById('preview');
    const processControls = document.getElementById('process-controls');
    const processingLoader = document.getElementById('processing-loader');
    const statusMessage = document.getElementById('status-message');
    const processButton = document.getElementById('process-btn');
    const retakeButton = document.getElementById('retake-btn');
    const documentList = document.getElementById('document-list');
    const searchBox = document.getElementById('search-box');
    const searchResults = document.getElementById('search-results');
    
    // Activer la cam√©ra
    startCameraButton.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        video.srcObject = stream;
        startCameraButton.disabled = true;
        captureButton.disabled = false;
      } catch (err) {
        console.error('Erreur lors de l\'acc√®s √† la cam√©ra:', err);
        alert('Impossible d\'acc√©der √† la cam√©ra. V√©rifiez vos permissions.');
      }
    });
    
    // Capturer une image
    captureButton.addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Pr√©-traitement - rognage automatique (simulation)
      // Dans une impl√©mentation r√©elle, utilisez une biblioth√®que comme OpenCV.js
      // pour la d√©tection des bords et le rognage
      
      capturedImage = canvas.toDataURL('image/jpeg');
      preview.src = capturedImage;
      preview.style.display = 'block';
      
      // Arr√™ter la cam√©ra pour √©conomiser la batterie
      stream.getTracks().forEach(track => track.stop());
      video.style.display = 'none';
      
      // Afficher les contr√¥les de traitement
      processControls.classList.remove('hidden');
      captureButton.disabled = true;
    });
    
    // Reprendre une photo
    retakeButton.addEventListener('click', async () => {
      preview.style.display = 'none';
      processControls.classList.add('hidden');
      statusMessage.classList.add('hidden');
      video.style.display = 'block';
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        video.srcObject = stream;
        captureButton.disabled = false;
      } catch (err) {
        console.error('Erreur lors de l\'acc√®s √† la cam√©ra:', err);
      }
    });
    
    // Traiter le document
    processButton.addEventListener('click', async () => {
      processControls.classList.add('hidden');
      processingLoader.classList.remove('hidden');
      statusMessage.classList.remove('hidden');
      statusMessage.textContent = "Extraction du texte via OCR...";
      
      try {
        // Convertir l'image en base64 sans le pr√©fixe data:image/jpeg;base64,
        const base64Image = capturedImage.split(',')[1];
        
        // Appel √† l'API OCR.space
        const extractedText = await performOCR(base64Image);
        
        statusMessage.textContent = "Identification du type de document via Gemini AI...";
        
        // Appel √† l'API Gemini pour classifier le document
        const documentType = await classifyDocumentWithGemini(extractedText);
        
        // G√©n√©ration d'un nom de fichier bas√© sur le contenu et le type
        const dateStr = new Date().toISOString().split('T')[0];
        const fileName = `${documentType}_${dateStr}_${Math.floor(Math.random() * 1000)}.pdf`;
        
        // Cr√©ation d'un nouvel objet document
        const newDocument = {
          id: Date.now(),
          fileName,
          type: documentType,
          text: extractedText,
          imageData: capturedImage,
          dateAdded: new Date().toISOString()
        };
        
        // Ajouter le document √† la liste
        documents.unshift(newDocument);
        
        // Sauvegarder dans le localStorage
        localStorage.setItem('documents', JSON.stringify(documents));
        
        // Mettre √† jour l'affichage
        updateDocumentList();
        
        // R√©initialiser l'interface
        processingLoader.classList.add('hidden');
        preview.style.display = 'none';
        video.style.display = 'block';
        startCameraButton.disabled = false;
        captureButton.disabled = true;
        statusMessage.classList.add('hidden');
        
        alert(`Document trait√© avec succ√®s!\nType d√©tect√©: ${documentType}\nNom de fichier: ${fileName}`);
      } catch (err) {
        console.error('Erreur lors du traitement du document:', err);
        alert('Erreur lors du traitement du document: ' + err.message);
        processingLoader.classList.add('hidden');
        processControls.classList.remove('hidden');
        statusMessage.textContent = "Erreur: " + err.message;
      }
    });
    
    // Fonction pour effectuer l'OCR via OCR.space
    async function performOCR(base64Image) {
      try {
        const formData = new FormData();
        formData.append('apikey', OCR_API_KEY);
        formData.append('base64Image', `data:image/jpeg;base64,${base64Image}`);
        formData.append('language', 'fre');
        formData.append('scale', 'true');
        formData.append('isTable', 'false');
        
        const response = await fetch('https://api.ocr.space/parse/image', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (!data.IsErroredOnProcessing) {
          return data.ParsedResults[0].ParsedText;
        } else {
          throw new Error(data.ErrorMessage || "Erreur lors de l'OCR");
        }
      } catch (error) {
        console.error("Erreur OCR:", error);
        // En cas d'erreur avec l'API, simuler un r√©sultat pour le d√©veloppement
        return "Facture N¬∞F2023-042\nDate: 15/03/2023\nClient: Dupont Jean\nMontant: 124,99‚Ç¨ TTC";
      }
    }
    
    // Fonction pour classifier le document avec Gemini AI
    async function classifyDocumentWithGemini(textContent) {
      try {
        const promptExpert = `
        Tu es un expert en classification de documents. Ta t√¢che est d'analyser un texte extrait d'un document et d'identifier son type parmi les cat√©gories suivantes :  
        - Documents financiers (facture, relev√© bancaire, bulletin de salaire, etc.)  
        - Documents l√©gaux (contrat, testament, acte notari√©, etc.)  
        - Documents d'identification (carte d'identit√©, passeport, permis de conduire, etc.)  
        - Documents administratifs (certificat, attestation, formulaire officiel, etc.)  
        - Documents commerciaux (devis, bon de commande, facture commerciale, etc.)  
        - Documents √©ducatifs (dipl√¥me, relev√© de notes, certificat de scolarit√©, etc.)  
        - Documents m√©dicaux (ordonnance, compte-rendu m√©dical, certificat m√©dical, etc.)  
        - Documents techniques (manuel d'utilisation, brevet, fiche technique, etc.)  
        - Documents de communication (lettre, e-mail, communiqu√©, etc.)  
        - Documents de voyage (billet d'avion, visa, r√©servation d'h√¥tel, etc.)  
        - Documents artistiques (partition, croquis, storyboard, etc.)  
        - Documents environnementaux (rapport √©cologique, norme ISO, etc.)  
        - Documents militaires (ordre de mission, rapport op√©rationnel, etc.)  
        - Documents religieux (certificat de bapt√™me, pri√®re, texte sacr√©, etc.)  
        
        Analyse le texte suivant et r√©ponds uniquement avec le nom de la cat√©gorie (pas de phrases compl√®tes, juste la cat√©gorie) :
        
        ${textContent}
        `;
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: promptExpert
              }]
            }]
          })
        });
        
        const data = await response.json();
        
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          const classification = data.candidates[0].content.parts[0].text.trim();
          return classification;
        } else {
          console.error("Erreur Gemini:", data);
          throw new Error("Impossible de classifier le document");
        }
      } catch (error) {
        console.error("Erreur classification Gemini:", error);
        // En cas d'erreur avec l'API, retourner une valeur par d√©faut
        return "Documents financiers";
      }
    }
    
    // Mettre √† jour la liste des documents
    function updateDocumentList(filteredDocs = null) {
      const docs = filteredDocs || documents;
      
      documentList.innerHTML = '';
      
      if (docs.length === 0) {
        documentList.innerHTML = '<li class="no-documents">Aucun document trouv√©.</li>';
        return;
      }
      
      docs.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'document-item';
        li.dataset.type = doc.type;
        
        const docInfo = document.createElement('div');
        docInfo.className = 'document-info';
        
        const docTitle = document.createElement('strong');
        docTitle.textContent = doc.fileName;
        
        const categoryTag = document.createElement('span');
        categoryTag.className = 'category-tag';
        categoryTag.textContent = doc.type.split(' ')[0];
        
        const docDate = document.createElement('small');
        docDate.textContent = new Date(doc.dateAdded).toLocaleDateString();
        
        docInfo.appendChild(docTitle);
        docInfo.appendChild(categoryTag);
        docInfo.appendChild(document.createElement('br'));
        docInfo.appendChild(docDate);
        
        const docActions = document.createElement('div');
        docActions.className = 'document-actions';
        
        const viewBtn = document.createElement('button');
        viewBtn.textContent = 'Voir';
        viewBtn.addEventListener('click', () => viewDocument(doc.id));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Supprimer';
        deleteBtn.addEventListener('click', () => deleteDocument(doc.id));
        
        docActions.appendChild(viewBtn);
        docActions.appendChild(deleteBtn);
        
        li.appendChild(docInfo);
        li.appendChild(docActions);
        
        documentList.appendChild(li);
      });
    }
    
    // Voir un document
    function viewDocument(id) {
      const doc = documents.find(d => d.id === id);
      if (!doc) return;
      
      // Cr√©er une fen√™tre modale pour afficher le document
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
      modal.style.zIndex = '1000';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      
      const content = document.createElement('div');
      content.style.backgroundColor = 'white';
      content.style.padding = '20px';
      content.style.borderRadius = '5px';
      content.style.maxWidth = '90%';
      content.style.maxHeight = '90%';
      content.style.overflow = 'auto';
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Fermer';
      closeBtn.style.marginTop = '15px';
      closeBtn.addEventListener('click', () => document.body.removeChild(modal));
      
      const docImage = document.createElement('img');
      docImage.src = doc.imageData;
      docImage.style.maxWidth = '100%';
      
      const docType = document.createElement('div');
      docType.style.marginTop = '10px';
      docType.style.padding = '5px 10px';
      docType.style.backgroundColor = '#f0f0f0';
      docType.style.borderRadius = '5px';
      docType.style.display = 'inline-block';
      docType.textContent = `Type: ${doc.type}`;
      
      const docText = document.createElement('pre');
      docText.style.marginTop = '15px';
      docText.style.whiteSpace = 'pre-wrap';
      docText.style.border = '1px solid #eee';
      docText.style.padding = '10px';
      docText.style.backgroundColor = '#f9f9f9';
      docText.textContent = doc.text;
      
      content.appendChild(document.createElement('h3')).textContent = doc.fileName;
      content.appendChild(docType);
      content.appendChild(docImage);
      content.appendChild(document.createElement('h4')).textContent = "Texte extrait:";
      content.appendChild(docText);
      content.appendChild(closeBtn);
      
      modal.appendChild(content);
      document.body.appendChild(modal);
    }
    
    // Supprimer un document
    function deleteDocument(id) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce document ?')) {
        documents = documents.filter(d => d.id !== id);
        localStorage.setItem('documents', JSON.stringify(documents));
        updateDocumentList();
      }
    }
    
    // Filtrage des documents par cat√©gorie
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const category = btn.dataset.category;
        if (category === 'all') {
          updateDocumentList();
        } else {
          const filtered = documents.filter(doc => doc.type.includes(category));
          updateDocumentList(filtered);
        }
      });
    });
    
    // Recherche de documents
    searchBox.addEventListener('input', () => {
      const query = searchBox.value.toLowerCase().trim();
      
      if (query === '') {
        searchResults.innerHTML = '';
        return;
      }
      
      const results = documents.filter(doc => 
        doc.fileName.toLowerCase().includes(query) || 
        doc.text.toLowerCase().includes(query)
      );
      
      searchResults.innerHTML = '';
      
      if (results.length === 0) {
        searchResults.innerHTML = '<p>Aucun r√©sultat trouv√©.</p>';
        return;
      }
      
      const resultList = document.createElement('ul');
      resultList.className = 'document-list';
      
      results.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'document-item';
        
        const docInfo = document.createElement('div');
        docInfo.className = 'document-info';
        
        const docTitle = document.createElement('strong');
        docTitle.textContent = doc.fileName;
        
        const categoryTag = document.createElement('span');
        categoryTag.className = 'category-tag';
        categoryTag.textContent = doc.type.split(' ')[0];
        
        docInfo.appendChild(docTitle);
        docInfo.appendChild(categoryTag);
        
        const viewBtn = document.createElement('button');
        viewBtn.textContent = 'Voir';
        viewBtn.addEventListener('click', () => viewDocument(doc.id));
        
        li.appendChild(docInfo);
        li.appendChild(viewBtn);
        
        resultList.appendChild(li);
      });
      
      searchResults.appendChild(resultList);
    });
    
    // Initialiser la liste des documents au chargement
    updateDocumentList();
  </script>
</body>
</html>